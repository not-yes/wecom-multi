name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-cli:
    name: Build CLI - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: wecom-multi-open-cli-windows.exe
            binary_name: wecom-multi-open.exe

          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: wecom-multi-open-cli-macos-intel
            binary_name: wecom-multi-open

          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: wecom-multi-open-cli-macos-m1
            binary_name: wecom-multi-open

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.target }}-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build CLI
        run: cargo build --release --target ${{ matrix.target }} --bin wecom-multi-open

      - name: Rename binary (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mv target/${{ matrix.target }}/release/${{ matrix.binary_name }} ${{ matrix.artifact_name }}

      - name: Rename binary (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          move target\${{ matrix.target }}\release\${{ matrix.binary_name }} ${{ matrix.artifact_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}

  build-gui:
    name: Build GUI - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
            target: x86_64-pc-windows-msvc

          - platform: macos-intel
            os: macos-latest
            target: x86_64-apple-darwin

          - platform: macos-m1
            os: macos-latest
            target: aarch64-apple-darwin

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.target }}-target-gui-${{ hashFiles('**/Cargo.lock') }}

      - name: Install frontend dependencies
        run: |
          cd ui
          npm ci
          cd ..

      - name: Build frontend
        run: |
          cd ui
          npm run build
          cd ..

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^1.5"

      - name: Build Tauri app
        run: cargo tauri build --target ${{ matrix.target }}

      - name: Upload Windows MSI
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: wecom-multi-open-gui-windows.msi
          path: target/${{ matrix.target }}/release/bundle/msi/*.msi

      - name: Upload macOS DMG
        if: matrix.platform == 'macos-intel' || matrix.platform == 'macos-m1'
        uses: actions/upload-artifact@v4
        with:
          name: wecom-multi-open-gui-${{ matrix.platform }}.dmg
          path: target/${{ matrix.target }}/release/bundle/dmg/*.dmg

      - name: Upload macOS App
        if: matrix.platform == 'macos-intel' || matrix.platform == 'macos-m1'
        uses: actions/upload-artifact@v4
        with:
          name: wecom-multi-open-gui-${{ matrix.platform }}.app
          path: target/${{ matrix.target }}/release/bundle/macos/*.app

  release:
    name: Create Release
    needs: [build-cli, build-gui]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: List downloaded files
        run: |
          ls -R

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            wecom-multi-open-cli-windows.exe/wecom-multi-open-cli-windows.exe
            wecom-multi-open-cli-macos-intel/wecom-multi-open-cli-macos-intel
            wecom-multi-open-cli-macos-m1/wecom-multi-open-cli-macos-m1
            wecom-multi-open-gui-windows.msi/wecom-multi-open_*_x64*.msi
            wecom-multi-open-gui-macos-intel.dmg/*.dmg
            wecom-multi-open-gui-macos-m1.dmg/*.dmg
          body: |
            ## ğŸ‰ ä¼ä¸šå¾®ä¿¡å¤šå¼€å·¥å…· v${{ steps.version.outputs.version }}

            ### ğŸ“¦ ä¸‹è½½æ–¹å¼

            #### ğŸ–¥ï¸ Windows ç”¨æˆ·

            **CLI ç‰ˆæœ¬ (å‘½ä»¤è¡Œ)**:
            - ä¸‹è½½: `wecom-multi-open-cli-windows.exe`
            - ä½¿ç”¨: åŒå‡»è¿è¡Œæˆ– `wecom-multi-open-cli-windows.exe 3`
            - ä½“ç§¯: ~1.5 MB

            **GUI ç‰ˆæœ¬ (å›¾å½¢ç•Œé¢)** â­ æ¨è:
            - ä¸‹è½½: `wecom-multi-open_*_x64.msi`
            - ä½¿ç”¨: åŒå‡»å®‰è£…ï¼Œç„¶åä»å¼€å§‹èœå•å¯åŠ¨
            - ä½“ç§¯: ~8 MB
            - åŠŸèƒ½: å›¾å½¢ç•Œé¢ + ç³»ç»Ÿæ‰˜ç›˜ + å®ä¾‹ç®¡ç†

            #### ğŸ macOS ç”¨æˆ·

            **CLI ç‰ˆæœ¬ (å‘½ä»¤è¡Œ)**:
            - Intel èŠ¯ç‰‡: ä¸‹è½½ `wecom-multi-open-cli-macos-intel`
            - M1/M2/M3 èŠ¯ç‰‡: ä¸‹è½½ `wecom-multi-open-cli-macos-m1`
            - ä½¿ç”¨: `chmod +x æ–‡ä»¶å && ./æ–‡ä»¶å 3`
            - ä½“ç§¯: ~600 KB

            **GUI ç‰ˆæœ¬ (å›¾å½¢ç•Œé¢)** â­ æ¨è:
            - Intel èŠ¯ç‰‡: ä¸‹è½½ `wecom-multi-open-gui-macos-intel.dmg`
            - M1/M2/M3 èŠ¯ç‰‡: ä¸‹è½½ `wecom-multi-open-gui-macos-m1.dmg`
            - ä½¿ç”¨: åŒå‡» DMGï¼Œæ‹–åŠ¨åˆ° Applications æ–‡ä»¶å¤¹
            - ä½“ç§¯: ~8 MB
            - åŠŸèƒ½: å›¾å½¢ç•Œé¢ + ç³»ç»Ÿæ‰˜ç›˜ + å®ä¾‹ç®¡ç†

            ğŸ’¡ **å¦‚ä½•é€‰æ‹©èŠ¯ç‰‡ç‰ˆæœ¬**:
            - è¿è¡Œ `uname -m` æŸ¥çœ‹: `arm64` = M1/M2/M3, `x86_64` = Intel

            ### âœ¨ åŠŸèƒ½ç‰¹æ€§

            | åŠŸèƒ½ | CLI ç‰ˆæœ¬ | GUI ç‰ˆæœ¬ |
            |------|---------|---------|
            | å¯åŠ¨å¤šä¸ªå®ä¾‹ | âœ… | âœ… |
            | å›¾å½¢ç•Œé¢ | âŒ | âœ… |
            | ç³»ç»Ÿæ‰˜ç›˜ | âŒ | âœ… |
            | å®ä¾‹ç®¡ç† | âŒ | âœ… |
            | å®æ—¶ç›‘æ§ | âŒ | âœ… |
            | å¿«æ·æ“ä½œ | âŒ | âœ… |

            ### ğŸš€ å¿«é€Ÿå¼€å§‹

            **Windows**:
            1. ä¸‹è½½ GUI ç‰ˆæœ¬ MSI å®‰è£…åŒ…
            2. åŒå‡»å®‰è£…
            3. ä»å¼€å§‹èœå•å¯åŠ¨"ä¼ä¸šå¾®ä¿¡å¤šå¼€å·¥å…·"

            **macOS**:
            1. ä¸‹è½½å¯¹åº”èŠ¯ç‰‡çš„ DMG æ–‡ä»¶
            2. åŒå‡»æ‰“å¼€ï¼Œæ‹–åŠ¨åˆ° Applications
            3. ä»å¯åŠ¨å°æˆ– Applications æ–‡ä»¶å¤¹å¯åŠ¨

            ### ğŸ“– è¯¦ç»†æ–‡æ¡£

            - [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) - é¡¹ç›®æ€»è§ˆ
            - [GUI_GUIDE.md](https://github.com/${{ github.repository }}/blob/main/GUI_GUIDE.md) - GUI ä½¿ç”¨æŒ‡å—
            - [MACOS_QUICKSTART.md](https://github.com/${{ github.repository }}/blob/main/MACOS_QUICKSTART.md) - macOS å¿«é€Ÿå¼€å§‹
            - [BUILD_GUIDE.md](https://github.com/${{ github.repository }}/blob/main/BUILD_GUIDE.md) - ç¼–è¯‘æŒ‡å—

            ### ğŸ¯ ç³»ç»Ÿè¦æ±‚

            - **Windows**: Windows 10/11 (64ä½)
            - **macOS**: macOS 10.15+ (Catalina æˆ–æ›´é«˜)
            - **å†…å­˜**: 4GB+ (æ¨è 8GB)
            - **ä¼ä¸šå¾®ä¿¡**: éœ€è¦å·²å®‰è£…

            ### ğŸ’¡ ä½¿ç”¨å»ºè®®

            - é¦–æ¬¡ä½¿ç”¨å»ºè®®å¯åŠ¨ 2-3 ä¸ªå®ä¾‹æµ‹è¯•
            - 8GB å†…å­˜å»ºè®® 3-5 ä¸ªå®ä¾‹
            - 16GB+ å†…å­˜å¯ä»¥å¯åŠ¨ 5-10 ä¸ªå®ä¾‹
            - GUI ç‰ˆæœ¬ä½¿ç”¨æ›´æ–¹ä¾¿ï¼Œæ¨èæ™®é€šç”¨æˆ·ä½¿ç”¨

            ---

            **æ„Ÿè°¢ä½¿ç”¨! å¦‚æœ‰é—®é¢˜è¯·æäº¤ Issue** ğŸ™
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
